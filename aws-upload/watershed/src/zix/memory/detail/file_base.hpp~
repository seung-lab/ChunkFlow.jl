//
// Copyright (C) 2010  Aleksandar Zlateski <zlateski@mit.edu>
// ----------------------------------------------------------
//
// This program is free software: you can redistribute it and/or modify
// it under the terms of the GNU General Public License as published by
// the Free Software Foundation, either version 3 of the License, or
// (at your option) any later version.
//
// This program is distributed in the hope that it will be useful,
// but WITHOUT ANY WARRANTY; without even the implied warranty of
// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
// GNU General Public License for more details.
//
// You should have received a copy of the GNU General Public License
// along with this program.  If not, see <http://www.gnu.org/licenses/>.
//

#ifndef ZI_MEMORY_DETAIL_FILE_HPP
#define ZI_MEMORY_DETAIL_FILE_HPP 1

#include <zi/concurrency/mutex.hpp>

#include <cstddef>
#include <cstdio>

#include <unistd.h>
#include <fcntl.h>

namespace zi {
namespace mem {
namespace detail {

class file
{
public:
    enum file_mode
    {
        RDONLY = 0x01,
        WRONLY = 0x02,
        RDWR   = 0x04,
        CREAT  = 0x08,
        DIRECT = 0x0f,
        TRUNC  = 0x10
    };

protected:
    mutex mutex_;
    int   fd_   ;
    int   mode_ ;
    const std::string filename_;

public:
    file( const std::string& filename, int mode )
        : mutex_(),
          fd_( -1 ),
          mode_( mode ),
          filename_( filename )
    {

#define ZI_MEM_DETAIL_ADD_FILE_FLAG( f )     \
        if ( mode && f )                     \
        {                                    \
            flags |= O_##f;                  \
        } static_cast< void >( 0 )           \

        ZI_MEM_DETAIL_ADD_FILE_FLAG( RDONLY );
        ZI_MEM_DETAIL_ADD_FILE_FLAG( WRONLY );
        ZI_MEM_DETAIL_ADD_FILE_FLAG( RDWR   );
        ZI_MEM_DETAIL_ADD_FILE_FLAG( CREAT  );
        ZI_MEM_DETAIL_ADD_FILE_FLAG( TRUNC  );

#undef ZI_MEM_DETAIL_ADD_FILE_FLAG

        if ( mode & DIRECT )
        {
            flags |= O_SYNC | O_RSYNC | O_DSYNC | O_DIRECT;
        }

        const int perms = S_IREAD | S_IWRITE | S_IRGRP | S_IWGRP;

        fd_ = ::open( filename_.c_str(), flags, perms );
    }

    std::size_t size()
    {
    }


} // namespace detail
} // namespace mem
} // namespace zi



